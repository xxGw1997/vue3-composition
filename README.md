# vue3-composition
ğŸ–ŠNote study vue3 composition resouce code


## 1ã€reactiveæ¨¡å—
è¿™ä¸ªæ¨¡å—ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯å‘å¤–æš´éœ²ä¸€ä¸ªæ–¹æ³•reactive,æ­¤æ–¹æ³•å¯ä»¥å°†ä¼ å…¥çš„å¯¹è±¡å‚æ•°åšå“åº”å¼å¤„ç†å¹¶ä¸”å°†è¿™ä¸ªproxyä»£ç†åçš„å‡½æ•°è¿”å›
(ç›®çš„å°±æ˜¯å½“è¯»å–å¯¹è±¡æ—¶ä¼šåšä¾èµ–æ”¶é›†,å½“æ•°æ®æ›´æ–°æ—¶ä¼šé‡æ–°æ‰§è¡Œeffectå‡½æ•°)
```
export function reactive(target){
  //å°†ç›®æ ‡å¯¹è±¡å˜æˆå“åº”å¼å¯¹è±¡,Proxy
  return createReactiveObject(target,mutableHandlers) //æ ¸å¿ƒæ“ä½œå°±æ˜¯å½“è¯»å–æ–‡ä»¶æ—¶åšä¾èµ–æ”¶é›†,å½“æ•°æ®å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œeffectå‡½æ•°
}
```
ä¸ºäº†æ›´å¥½çš„è§£è€¦ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„æ˜¯createReactiveObject(target,mutableHandlers)å‡½æ•°,
å› ä¸ºå¯ä»¥æ ¹æ®ç¬¬äºŒä¸ªå‚æ•°ä¸åŒ,åç»­è¿˜å¯ä»¥å»åšå…¶ä»–çš„æ“ä½œï¼Œç°åœ¨è¿™é‡Œåªæ˜¯åšå¯¹è±¡çš„ä»£ç†æ“ä½œ
ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦ä»£ç†çš„å¯¹è±¡,
ç¬¬äºŒä¸ªå‚æ•°å®é™…ä¸Šåœ¨è¿™é‡Œåšå¯¹è±¡çš„ä»£ç†å°±æ˜¯new Proxyçš„ç¬¬äºŒä¸ªä»£ç†çš„å…·ä½“æ“ä½œ


```
const proxyMap = new WeakMap()

function createReactiveObject(target,baseHandlers){
  //å¦‚æœç›®æ ‡ä¸æ˜¯å¯¹è±¡,åˆ™ç›´æ¥è¿”å›
  if(!isObject(target)) return target
  const existingProxy = proxyMap.get(target)
  if(existingProxy) return existingProxy  //å¦‚æœå­˜åœ¨,åˆ™è¡¨ç¤ºä¹‹å‰ä»£ç†è¿‡,ç›´æ¥è¿”å›
  //åªå¯¹æœ€å¤–å±‚å¯¹è±¡åšä»£ç†,é»˜è®¤ä¸ä¼šé€’å½’,è€Œä¸”ä¸ä¼šé‡æ–°é‡å†™å¯¹è±¡ä¸­çš„å±æ€§
  const proxy = new Proxy(target,baseHandlers)
  proxyMap.set(target,proxy)  //å°†éœ€è¦ä»£ç†çš„å¯¹è±¡å’Œä»£ç†çš„ç»“æœåšæˆä¸€ä¸ªæ˜ å°„è¡¨
  return proxy
}
```
åœ¨å…¨å±€å®šä¹‰ä¸€ä¸ªweakMap,å› ä¸ºweakMapå¯ä»¥ä½¿ç”¨objectä½œä¸ºkey,å¹¶ä¸”ä¸å¯é‡å¤,æ‰€ä»¥å¯ä»¥ç”¨æ¥å¯¹éœ€è¦ä»£ç†çš„å¯¹è±¡å’Œä»£ç†çš„ç»“æœåšä¸€ä¸ªæ˜ å°„è¡¨,é˜²æ­¢é‡å¤ä»£ç†
å®šä¹‰ä¸€ä¸ªæ–¹æ³•createReactiveObject(target,baseHandlers)è¿™ä¸ªæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°
ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦å¤„ç†çš„å¯¹è±¡,ç¬¬äºŒä¸ªå‚æ•°æ˜¯éœ€è¦å¤„ç†çš„å…·ä½“æ“ä½œ
æœ€åæ˜¯è¿”å›ä¸€ä¸ªä»£ç†åçš„proxyå¯¹è±¡
é¦–å…ˆéœ€è¦å¯¹è±¡ä»£ç†çš„å¯¹è±¡è¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­
å¦‚æœä¼ å…¥çš„ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡åˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†æ“ä½œ
ç„¶åå†åˆ°weakMapä¸­æŸ¥æ‰¾ä¹‹å‰æ˜¯å¦å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œè¿‡æ“ä½œ,å¦‚æœæ˜¯åˆ™ç›´æ¥å–å€¼è¿”å›å³å¯
å¦‚æœæ˜¯ä¸€ä¸ªéœ€è¦æ–°ä»£ç†çš„å¯¹è±¡åˆ™å¯¹è¯¥å¯¹è±¡è¿›è¡ŒProxyè¿›è¡Œä»£ç†æ“ä½œ,å…·ä½“çš„æ“ä½œäº¤ç»™baseHandlerså³å¯
æ‰€ä»¥è¯¥æ¨¡å—åªéœ€è¦å…³å¿ƒçš„æ˜¯æ¥æ”¶ä¸€ä¸ªå¯¹è±¡å¹¶å¯¹è¯¥å¯¹è±¡è¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­,ç„¶åå°†è¿™ä¸ªä»£ç†åçš„å¯¹è±¡è¿”å›å³å¯
å…·ä½“ä»£ç†çš„æ“ä½œå’Œä¾èµ–æ”¶é›†åªéœ€è¦äº¤ç»™baseHandleræ¨¡å—å»åšå°±è¡Œ
è‡³æ­¤reactiveæ¨¡å—åŠŸèƒ½å·²ç»å®Œæˆ

## 2ã€baseHandlersæ¨¡å—
æ¥ç€ç¬¬ä¸€ä¸ªæ¨¡å—ä¸­å¯¹è±¡ä»£ç†çš„å…·ä½“æ“ä½œéœ€è¦å…·ä½“åšå“ªäº›äº‹æƒ…,baseHandlersæ¨¡å—çš„å·¥ä½œå°±æ˜¯å¯¹å¯¹è±¡ä»£ç†çš„å…·ä½“æ“ä½œ
å…¶æœ¬è´¨å°±æ˜¯è¿”å›ä¸€ä¸ªhandlerå¯¹è±¡{get,set},é‡Œé¢æœ‰ä¸¤ä¸ªæ–¹æ³•,åˆ†åˆ«æ˜¯getå’Œsetã€‚
Proxyä»£ç†ä¼šå°†å¯¹è±¡ä¸­æ¯ä¸€ä¸ªå±æ€§è¿›è¡Œä»£ç†æ“ä½œ,è®¿é—®å¯¹è±¡ä¸­å±æ€§å°±æ˜¯è§¦å‘å¯¹åº”çš„get,å¯¹æŸä¸ªå±æ€§ä¿®æ”¹å°±ä¼šè§¦å‘å¯¹åº”çš„set
Proxyå°±æ˜¯ä»£æ›¿definePropertyçš„,æ‰€ä»¥å½“è®¿é—®éœ€è¦ä»£ç†çš„å¯¹è±¡ä¸­æŸä¸€ä¸ªæ–¹æ³•æ—¶,ä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥handlerå¯¹è±¡ä¸­çš„getæ–¹æ³•
å½“ä¿®æ”¹éœ€è¦ä»£ç†å¯¹è±¡ä¸­æŸä¸€ä¸ªå±æ€§æ—¶,ä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥handlerå¯¹è±¡ä¸­çš„setæ–¹æ³•
```
export const mutableHandlers = {
  get,
  set
}
```
è¿”å›ä¸€ä¸ªå¯¹è±¡,åˆ†åˆ«æœ‰getå’Œsetä¸¤ä¸ªæ–¹æ³•


```
const get = createGetter()
const set = createSetter()
```
åˆ©ç”¨å‡½æ•°æŸ¯é‡ŒåŒ–ç»™å‡½æ•°å…ˆé¢„ç½®å‚æ•°
createGetter(),createSetter()ä¸¤ä¸ªæ–¹æ³•ä½œç”¨å°±æ˜¯åˆ†åˆ«è¿”å›ä¸¤ä¸ªå‡½æ•°
æ¥ä¸‹æ¥è¦å…·ä½“ç¼–å†™createGetter(),createSetter()
### createGetter()
```
function createGetter() {
  return function get(target, key, receiver) {  //è·å–å±æ€§çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œget()æ–¹æ³•
    const res = Reflect.get(target, key, receiver)  //ç›¸å½“äºtarget[key]
    //å¦‚æœå–å€¼æ˜¯symbolç±»å‹ åˆ™éœ€è¦å¿½ç•¥
    if (isSymbol(key)) {
      return res
    }
    //ä¾èµ–æ”¶é›†
    track(target, key)
    console.log('æ•°æ®get')

    if (isObject(key)) {  //å–å€¼æ˜¯å¯¹è±¡ å†è¿›è¡Œé€’å½’ä»£ç†->æ‡’é€’å½’
      return reactive(key)
    }
    return res
  }
}
```
createGetteræ–¹æ³•è¿”å›ä¸€ä¸ªgetå‡½æ•°
å½“è®¿é—®å¯¹è±¡ä¸­æŸå±æ€§æ—¶,å°±æ˜¯è‡ªåŠ¨æ‰§è¡Œgetå‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°target,key,receiveråˆ†åˆ«ä»£è¡¨çš„æ˜¯,éœ€è¦ä»£ç†çš„åŸå¯¹è±¡,è®¿é—®ä»£ç†å¯¹è±¡çš„å±æ€§key,ç”¨äºæ¥å—ä»£ç†çš„å¯¹è±¡çš„receiver
Reflect.get(target,key,receiver) å°±ç›¸å½“äºtarget[key],Reflectä¼šè¿”å›æ“ä½œæˆåŠŸæˆ–è€…å¤±è´¥,å¯ä»¥ç”¨æ¥ç”¨ä½œåç»­çš„åˆ¤æ–­
å…ˆåˆ¤æ–­keyæ˜¯å¦æ˜¯Symbolç±»å‹,å¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›
reactiveæœ€ä¸»è¦å°±æ˜¯åœ¨è®¿é—®æŸä¸ªå±æ€§æ—¶åšä¾èµ–æ”¶é›†,è€Œåœ¨reactive({ name: 'ywx', age: 23, address: 'hangzhou' })æ—¶,å°±ä¼šå¯¹å¯¹è±¡çš„å±æ€§åšä¾èµ–æ”¶é›†,
æ‰€ä»¥éœ€è¦æ‰§è¡Œtrackå‡½æ•°
ç„¶åå†åˆ¤æ–­è¯¥keyæ˜¯å¦æ˜¯å¯¹è±¡,å¦‚æœæ˜¯å¯¹è±¡æ‰ä¼šå»é€’å½’ä»£ç†è¯¥å¯¹è±¡

### createSetter()
```
function createSetter() {
  return function set(target, key, value, receiver) {  //è®¾ç½®å±æ€§çš„å€¼çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œset()æ–¹æ³•
    //æ–°å¢è¿˜æ˜¯ä¿®æ”¹
    const oldValue = target[key]
    //çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰è¿™ä¸ªå±æ€§

    //1ã€æ•°ç»„æ–°å¢å±æ€§     2ã€å¯¹è±¡æ–°å¢å±æ€§
    const hadKey = isArray(target) && isInteger(key) ? Number(key) < target.length : hasOwn(target, key)
    const res = Reflect.set(target, key, value, receiver)
    if (!hadKey) {
      trigger(target, 'add', key, value)
    } else if (hasChanged(value, oldValue)) {
      trigger(target, 'set', key, value, oldValue)
    }
    return res
  }
}
```
createSetteræ–¹æ³•è¿”å›ä¸€ä¸ªsetå‡½æ•°
å½“ä¿®æ”¹å¯¹è±¡ä¸­æŸå±æ€§æ—¶,å°±ä¼šè‡ªåŠ¨æ‰§è¡Œsetå‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°target,key,value,receiveråˆ†åˆ«ä»£è¡¨çš„æ˜¯,ä»£ç†çš„åŸå¯¹è±¡,ä¿®æ”¹å¯¹è±¡çš„å±æ€§key,ä¿®æ”¹çš„æ–°å€¼,ç”¨äºæ¥å—ä»£ç†çš„å¯¹è±¡çš„receiver
é¦–å…ˆå°†ä¹‹å‰çš„è€å€¼å…ˆä¿å­˜,ç„¶åå†åˆ¤æ–­è¯¥ ä»£ç†çš„å¯¹è±¡æ˜¯ä¸€ä¸ªObjectè¿˜æ˜¯Arrayå¹¶ä¸”ä¿®æ”¹çš„keyæ˜¯å¦æ˜¯æ•°ç»„çš„ä¸‹æ ‡
1ã€å¦‚æœä¸æ˜¯æ•°ç»„åˆ™å°±æ˜¯ä¸€ä¸ªå¯¹è±¡->å†åˆ¤æ–­è¿™ä¸ªèµ‹å€¼æ“ä½œæ˜¯å¯¹åŸæœ‰å±æ€§ä¿®æ”¹è¿˜æ˜¯æ–°å¢ä¸€ä¸ªå±æ€§
2ã€å¦‚æœæ˜¯ä¸€ä¸ªæ•°ç»„ä½†æ˜¯ä¿®æ”¹çš„ä¸æ˜¯æ•°ç»„çš„ä¸‹æ ‡,é‚£ä¹Ÿå½“ä½œå¯¹è±¡æ¥å¤„ç†->å†åˆ¤æ–­è¿™ä¸ªèµ‹å€¼æ“ä½œæ˜¯å¯¹åŸæœ‰å±æ€§ä¿®æ”¹è¿˜æ˜¯æ–°å¢ä¸€ä¸ªå±æ€§
3ã€å¦‚æœæ˜¯ä¸€ä¸ªæ•°ç»„å¹¶ä¸”ä¿®æ”¹çš„æ˜¯ä¸‹æ ‡->åˆ¤æ–­æ˜¯ä¿®æ”¹åŸæ•°ç»„ä¸­æŸä¸€ä¸ªä¸‹æ ‡çš„å€¼è¿˜æ˜¯æ–°å¢ä¸€ä¸ªå€¼çš„æ“ä½œ
å¯¹äºä¿®æ”¹å±æ€§å’Œæ–°å¢å±æ€§åšå‡ºåŒºåˆ«,åˆ†åˆ«è¿›è¡Œå¯¹åº”å±æ€§éœ€è¦è§¦å‘æ›´æ–°çš„æ“ä½œtrgger()
