{"version":3,"file":"vue.js","sources":["../src/reactivity/computed.ts","../src/shared/index.ts","../src/reactivity/effect.ts","../src/reactivity/baseHandlers.ts","../src/reactivity/reactive.ts","../src/reactivity/ref.ts"],"sourcesContent":["export function computed(){\r\n  \r\n}","export const isObject = (val) => typeof val == 'object' && val !== null\r\nexport const isSymbol = (val) => typeof val == 'symbol'\r\nexport const isArray = Array.isArray\r\nexport const isInteger = key => '' + parseInt(key, 10) === key\r\n\r\nconst hasOwnProperty = Object.prototype.hasOwnProperty\r\n\r\nexport const hasOwn = (val, key) => hasOwnProperty.call(val, key)\r\n\r\nexport const hasChanged = (value, oldValue) => value !== oldValue","import { isArray, isInteger } from \"../shared/index\";\r\n\r\nexport function effect(fn, options: any = {}) {  //effect => vue watcher\r\n  const effect = createReactiveEffect(fn, options)\r\n  if (!options.lazy) {\r\n    effect()\r\n  }\r\n  return effect\r\n}\r\n\r\nlet activeEffect //用来存储当前的effect函数\r\nlet uid = 0\r\nconst effectStack = []\r\nfunction createReactiveEffect(fn, options) {\r\n  const effect = function () {\r\n    if (!effectStack.includes(effect)) {  //防止递归执行\r\n      try {\r\n        activeEffect = effect\r\n        effectStack.push(activeEffect)\r\n        return fn()  //需要执行的逻辑,内部会对依赖的数据进行取值get()操作,在取值时可以拿到activeEffects\r\n      } finally {\r\n        effectStack.pop()\r\n        activeEffect = effectStack[effectStack.length - 1]\r\n      }\r\n    }\r\n  }\r\n  effect.id = uid++\r\n  effect.deps = []  //用来表示effect中依赖了哪些属性\r\n  effect.options = options\r\n  return effect\r\n}\r\n\r\n//{object:{key:[effect1,effect2]}}\r\nconst targetMap = new WeakMap()\r\n//将属性和effect做一个关联\r\nexport function track(target, key) {\r\n  if (activeEffect == undefined) {\r\n    return\r\n  }\r\n  let depsMap = targetMap.get(target)\r\n  if (!depsMap) {\r\n    targetMap.set(target, (depsMap = new Map()))\r\n  }\r\n  let dep = depsMap.get(key)\r\n  if (!dep) {\r\n    depsMap.set(key, (dep = new Set()))\r\n  }\r\n  if (!dep.has(activeEffect)) {\r\n    dep.add(activeEffect)\r\n    activeEffect.deps.push(dep) //双向绑定\r\n  }\r\n}\r\n\r\n//触发更新\r\nexport function trigger(target, type, key, value?, oldValue?) {   //{ name: 'ywx', age: 23, address: 'hangzhou' }\r\n  const depsMap = targetMap.get(target)\r\n  if (!depsMap) return\r\n  const run = effects => {\r\n    if (effects) effects.forEach(effect => effect())\r\n  }\r\n  //数组有特殊情况\r\n  if (key === 'length' && isArray(target)) {\r\n    depsMap.forEach((dep, key) => {\r\n      if (key == 'length' || key >= value) {  //在数组中如果修改的长度小于原有数组的长度时，也要更新视图\r\n        run(dep)\r\n      }\r\n      switch (type) {\r\n        case 'add':\r\n          if (isArray(target)) {  //给数组如果通过索引增加选项\r\n            //如果页面中直接使用了数组,也会对数组进行取值操作,\r\n            //对length进行收集,新增属性时,直接触发length即可\r\n            if (isInteger(key)) run(depsMap.get('length'))\r\n          }\r\n          break;\r\n\r\n        default:\r\n          break;\r\n      }\r\n    })\r\n  } else {\r\n    //对象的处理\r\n    if (key != void 0) {//说明修改了key\r\n      run(depsMap.get(key))\r\n    }\r\n  }\r\n}","import { isSymbol, isObject, isArray, isInteger, hasOwn, hasChanged } from \"../shared/index\";\r\nimport { reactive } from \"./reactive\";\r\nimport { track, trigger } from './effect'\r\n\r\nfunction createGetter() {\r\n  return function get(target, key, receiver) {  //获取属性的时候会自动执行get()方法\r\n    const res = Reflect.get(target, key, receiver)  //相当于target[key]\r\n    //如果取值是symbol类型 则需要忽略\r\n    if (isSymbol(key)) {\r\n      return res\r\n    }\r\n    //依赖收集\r\n    track(target, key)\r\n    console.log('数据get')\r\n\r\n    if (isObject(res)) {  //取值是对象 再进行递归代理->懒递归\r\n      return reactive(res)\r\n    }\r\n    return res\r\n  }\r\n}\r\n\r\nfunction createSetter() {\r\n  return function set(target, key, value, receiver) {  //设置属性的值的时候会自动执行set()方法\r\n    //新增还是修改\r\n    const oldValue = target[key]\r\n    //看一下有没有这个属性\r\n\r\n    //1、数组新增属性     2、对象新增属性\r\n    const hadKey = isArray(target) && isInteger(key) ? Number(key) < target.length : hasOwn(target, key)\r\n    const res = Reflect.set(target, key, value, receiver)\r\n    if (!hadKey) {\r\n      trigger(target, 'add', key, value)\r\n    } else if (hasChanged(value, oldValue)) {\r\n      trigger(target, 'set', key, value, oldValue)\r\n    }\r\n    return res\r\n  }\r\n}\r\n\r\n//为了预先放参数\r\nconst get = createGetter()\r\nconst set = createSetter()\r\n\r\n\r\nexport const mutableHandlers = {\r\n  get,\r\n  set\r\n}\r\n","import { isObject } from \"../shared/index\"\r\nimport { mutableHandlers } from \"./baseHandlers\"\r\n\r\nexport function reactive(target){\r\n  //将目标对象变成响应式对象,Proxy\r\n  return createReactiveObject(target,mutableHandlers) //核心操作就是当读取文件时做依赖收集,当数据变化时重新执行effect函数\r\n}\r\n\r\nconst proxyMap = new WeakMap()\r\n\r\nfunction createReactiveObject(target,baseHandlers){\r\n  //如果目标不是对象,则直接返回\r\n  if(!isObject(target)) return target\r\n  const existingProxy = proxyMap.get(target)\r\n  if(existingProxy) return existingProxy  //如果存在,则表示之前代理过,直接返回\r\n  //只对最外层对象做代理,默认不会递归,而且不会重新重写对象中的属性\r\n  const proxy = new Proxy(target,baseHandlers)\r\n  proxyMap.set(target,proxy)  //将需要代理的对象和代理的结果做成一个映射表\r\n  return proxy\r\n}","export function ref(){\r\n  \r\n}"],"names":[],"mappings":"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"}